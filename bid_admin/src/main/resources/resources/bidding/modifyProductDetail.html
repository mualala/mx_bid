<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title> - 修改竞标单 </title>
    <meta name="keywords" content="">
    <meta name="description" content="">

    <link rel="shortcut icon" href="favicon.ico">
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../framework/css/bootstrap-table.min.css" rel="stylesheet">
    <link href="../../framework/css/font-awesome.min.css?v=4.4.0" rel="stylesheet">

    <link href="../../framework/css/animate.css" rel="stylesheet">
    <link href="../../framework/css/style.css?v=4.1.0" rel="stylesheet">


    <style>
        .mark {color: red; background: white;}
    </style>
</head>

<body class="gray-bg">
<div id="bidTable" class="animated fadeInUp">
    <div class="wrapper wrapper-content">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">

                    <div class="ibox-title">
                        <h5>修改竞标单</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="form_basic.html#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-user">
                                <li><a href="form_basic.html#">选项1</a>
                                </li>
                                <li><a href="form_basic.html#">选项2</a>
                                </li>
                            </ul>
                            <a class="close-link"><i class="fa fa-times"></i></a>

                        </div>
                    </div>

                    <div class="ibox-content">
                        <form class="form-horizontal m-t" v-on:submit.prevent="disableFormSubmit">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">竞标单名称:</label>
                                <div class="col-sm-3">
                                    <input v-model="name"
                                           v-on:blur="checkName"
                                           minlength="1"
                                           type="text"
                                           class="form-control" required="" aria-required="true" />
                                </div>
                                <span class="mark">*</span>
                                <i v-bind:class="{hidden: nameTipOptions.isDuplicatName}"
                                   v-bind:style="{color: nameTipOptions.color}"
                                   aria-hidden="true">
                                    {{nameTipOptions.duplicatNameTip}}
                                </i>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">标记:</label>
                                <div class="col-sm-1">
                                    <input type="radio" id="come" value="1" v-model="mark">
                                    <label for="come">招标</label><i class="fa fa-arrow-circle-up" aria-hidden="true"></i>
                                </div>
                                <div class="col-sm-1">
                                    <input type="radio" id="to" value="2" v-model="mark">
                                    <label for="to">竞标</label><i class="fa fa-arrow-circle-down" aria-hidden="true"></i>
                                </div>
                                <span class="mark">*</span>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-2 control-label">竞标单开启时间:</label>
                                <div class="col-sm-3">
                                    <input v-model="startTime"
                                           id="startTime"
                                           @click="initDate(-1, 3, '#startTime')"
                                           class="form-control laydate-icon form-control layer-date"
                                           required="" aria-required="true">
                                </div>
                                <span class="mark">*</span>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">竞标单结束时间:</label>
                                <div class="col-sm-3">
                                    <input v-model="endTime"
                                           id="endTime"
                                           @click="initDate(-1, 4, '#endTime')"
                                           class="form-control laydate-icon form-control layer-date" required="" aria-required="true">
                                </div>
                                <span class="mark">*</span>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-2 control-label">详细描述：</label>
                                <div class="col-sm-8">
                                    <textarea v-model="bidDesc" class="form-control"></textarea>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="col-sm-4 col-sm-offset-5">
                                    <div class="btn-group">
                                        <button :class="{disabled: nameTipOptions.disabled}"
                                                class="btn btn-primary" @click="submitBid(1)">
                                            <i class="fa fa-gavel" aria-hidden="true"></i>提交修改
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- 供应商表格 -->
    <div>
        <div class="row">
            <div class="col-sm-6 pull-left">
                <div class="btn-group">
                    <a href="#addSupplierModal" data-toggle="modal" type="button" class="btn btn-primary" data-target="#addSupplierModal">
                        <i class="fa fa-plus-circle" aria-hidden="true"></i>添加约束供应商
                    </a>
                </div>
                <div class="btn-group">
                    <a onclick="bidding.deleteAll();" type="button" class="btn btn-danger">
                        <i class="fa fa-times" aria-hidden="true"></i>全部删除
                    </a>
                </div>
            </div>
            <!--<div class="col-sm-3 pull-right">-->
            <!--<div class="input-group">-->
            <!--<input type="text" class="form-control input-group-xs" placeholder="关键词搜索">-->
            <!--<span class="input-group-btn">-->
            <!--<button class="btn btn-default" type="button"><i class="fa fa-search"></i></button>-->
            <!--</span>-->
            <!--</div>-->
            <!--</div>-->
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover" data-show-columns="true" data-mobile-responsive="true">
                <thead class="thead-default">
                <tr>
                    <!--<th><input type="checkbox"></th>-->
                    <th>序号</th>
                    <th>供应商类型</th>
                    <th>供应商ID</th>
                    <th>供应商账号</th>
                    <th>联系人</th>
                    <th>电话</th>
                    <th>公司名称</th>
                    <th>法人</th>
                    <th>公司地址</th>
                    <th>公司简介</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="(addSu, index) in addSuppliers">
                    <!--<td><input type="checkbox" :value="index" v-model="checkedRows"></td>-->
                    <td>{{index + 1}}</td>
                    <td>{{addSu.name}}</td>
                    <td>{{addSu.supplierId}}</td>
                    <td>{{addSu.username}}</td>
                    <td>{{addSu.name}}</td>
                    <td>{{addSu.phone}}</td>
                    <td class="col-sm-1">{{addSu.companyName}}</td>
                    <td>{{addSu.legal}}</td>
                    <td>{{addSu.companyAddress}}</td>
                    <td class="col-sm-1">{{addSu.companyDesc}}</td>
                    <td><div class="btn btn-danger" @click="deleteSupplierOne(index)"><i class="fa fa-times" aria-hidden="true"></i>删除</div></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <br />
    <br />
    <br />
    <hr />
    <hr />
    <div>
        <div class="row">
            <div class="col-sm-6 pull-left">
                <div class="btn-group">
                    <a href="#addProductModal" data-toggle="modal" type="button" class="btn btn-primary" data-target="#addProductModal">
                        <i class="fa fa-plus-circle" aria-hidden="true"></i>添加产品
                    </a>
                </div>
                <div class="btn-group">
                    <a onclick="bidding.deleteAll();" type="button" class="btn btn-danger">
                        <i class="fa fa-times" aria-hidden="true"></i>全部删除
                    </a>
                </div>
            </div>
            <!--<div class="col-sm-3 pull-right">-->
                <!--<div class="input-group">-->
                    <!--<input type="text" class="form-control input-group-xs" placeholder="关键词搜索">-->
                    <!--<span class="input-group-btn">-->
                        <!--<button class="btn btn-default" type="button"><i class="fa fa-search"></i></button>-->
                    <!--</span>-->
                <!--</div>-->
            <!--</div>-->
        </div>

        <div class="table-responsive">
        <table id="" class="table table-bordered table-hover" data-show-columns="true" data-mobile-responsive="true">
            <thead class="thead-default">
            <tr>
                <!--<th><input type="checkbox"></th>-->
                <th>序号</th>
                <th>产品编码</th>
                <th>产品名称</th>
                <th>产品规格</th>
                <th>产品数量</th>
                <th>产品单位</th>
                <th>起拍价(元)</th>
                <th>竞价阶梯(元)</th>
                <th>交货期限</th>
                <th>付款期限</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="(addProduct, index) in addProducts">
                <!--<td><input type="checkbox" :value="index" v-model="checkedRows"></td>-->
                <td>{{index + 1}}</td>
                <td>{{addProduct.code}}</td>
                <td>{{addProduct.name}}</td>
                <td>{{addProduct.spec}}</td>
                <td class="col-sm-1"><input v-model="addProduct.number" type="number" class="form-control" /></td>
                <td>{{addProduct.unit}}</td>
                <td class="col-sm-1"><input v-model="addProduct.maxUnitPrice" type="number" class="form-control" /></td>
                <td class="col-sm-1"><input v-model="addProduct.step" type="number" class="form-control" /></td>
                <td class="col-sm-2">
                    <input v-model="addProduct.endDeliveryDate"
                           class="form-control laydate-icon layer-date"
                           id="endDeliveryDate"
                           @click="initDate(index, 1, '#endDeliveryDate')" />
                </td>
                <td class="col-sm-2">
                    <input v-model="addProduct.endPayDate"
                           class="form-control laydate-icon layer-date"
                           id="endPayDate"
                           @click="initDate(index, 2, '#endPayDate')" />
                </td>
                <td><div class="btn btn-danger" @click="deleteOne(index)"><i class="fa fa-times" aria-hidden="true"></i>删除</div></td>
            </tr>
            </tbody>
        </table>
        </div>
    </div>
</div>

<!-- 添加供应商的模态框 -->
<div class="modal fade" id="addSupplierModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true" id="x">&times;</span><span class="sr-only">Close</span></button>
                <h3 class="modal-title">添加供应商信息 </h3>
                <!--<span class="help-block m-b-none"><i class="fa fa-info-circle"></i>选择了 3 个产品</span>-->
            </div>
            <div class="modal-body">
                <div class="col-sm-12">
                    <form class="form-inline m-t">
                        <div class="form-group">
                            <label class="col-sm-5 control-label" for="supplierType">供应商类型:</label>
                            <div class="col-sm-7">
                                <select id="supplierType" style="width:150px" class="form-control" required>
                                    <option value="-1" selected="selected">---请选择供应商类型---</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>

                <table id="getSuppliers" class="table table-bordered table-hover"></table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" data-dismiss="modal">close</button>
                <!--<button id="addBtn" type="button" class="btn btn-primary" data-dismiss="modal">添加产品</button>-->
            </div>
        </div>
    </div>
</div>
<!-- 添加产品的模态框 -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true" id="x">&times;</span><span class="sr-only">Close</span></button>
                <h3 class="modal-title">添加产品信息 </h3>
                <span class="help-block m-b-none"><i class="fa fa-info-circle"></i>选择了 3 个产品</span>
            </div>
            <div class="modal-body">
                <div class="col-sm-12">
                    <form class="form-inline m-t">
                        <div class="form-group">
                            <label class="col-sm-4 control-label" for="productType">产品类型:</label>
                            <div class="col-sm-1">
                                <select id="productType" style=" width:200px" class="form-control" required>
                                    <option value="-1" selected="selected">---请选择产品类型---</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>

                <table id="getProducts" class="table table-bordered table-hover"></table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" data-dismiss="modal">close</button>
                <!--<button id="addBtn" type="button" class="btn btn-primary" data-dismiss="modal">添加产品</button>-->
            </div>
        </div>
    </div>
</div>

<!-- 全局js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="http://apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
<script src="../../framework/js/bootstrap-table.min.js"></script>
<script src="../../framework/js/bootstrap-table-zh-CN.js"></script>

<!-- jQuery Validation plugin javascript-->
<script src="../../framework/js/plugins/validate/jquery.validate.min.js"></script>
<script src="../../framework/js/plugins/validate/messages_zh.min.js"></script>
<script src="../../framework/js/plugins/layer/layer.min.js"></script>
<script src="../../framework/js/plugins/layer/laydate/laydate.js"></script>

<!--<script src="../../framework/js/qs.js"></script>-->
<!--<script src="https://cdn.bootcss.com/axios/0.18.0/axios.min.js"></script>-->
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

<!-- 自定义js -->
<script src="../../myjs/utils.js"></script>
<script src="../../myjs/bidding.js"></script>

<script>
    //模态框拖动
    $(document).on("show.bs.modal", ".modal", function(){
        $(this).draggable({
//		        handle: ".modal-header"   //只能点击头部拖动
        });
        $(this).css("overflow", "hidden"); //防止出现滚动条，出现的话，你会把滚动条一起拖着走的
    });

    // 添加供应商的模态框
    $('#addSupplierModal').on('shown.bs.modal', function () {
        bidding.suppliers.supplierTypeNames($('#supplierType'), null)
        bidding.suppliers.initSuppliers()
    });
    $('#supplierType').change(function () {
        bidding.suppliers.initSuppliers()
    });
    $('#addSupplierModal').on('hidden.bs.modal', function () {
        $("#supplierType").find("option").not(":first").remove();
    })
    // 添加产品的模态框
    $('#addProductModal').on('shown.bs.modal', function () {
        bidding.productTypeNames($('#productType'), null);
        bidding.products.initProducts();
    });
    $('#productType').change(function () {
        bidding.products.initProducts();
    });
    $('#addProductModal').on('hidden.bs.modal', function () {
        $("#productType").find("option").not(":first").remove();
    })


    var haha = new Vue({
        el: '#bidTable',
        data: {
            initName: '',

            name: '',
            mark: 0,
            startTime: '',
            endTime: '',
            bidDesc: '',

            addSuppliers: bidding.supplierDatas,//添加的供应商
            addProducts: bidding.productDatas, //添加的产品数据
            biddings: [], //提交的竞标单数据

            nameTipOptions: {
                disabled: false,        //创建竞标单的按钮置灰  不可创建标单
                isDuplicatName: true,  //禁掉                   可创建标单
                duplicatNameTip: '',
                color: '',
                icon: ['fa fa-check', 'fa fa-times'],
            },
        },

        methods: {
            deleteOne: function (index) {
                bidding.productDatas.splice(index, 1)
            },

            deleteSupplierOne: function (index) {
                bidding.supplierDatas.splice(index, 1)
            },

            // 初始化日期
            initDate: function (index, mark, elem) {
                laydate({
                    elem: elem,
                    istime: true,
                    theme: 'molv',
                    format: 'YYYY-MM-DD hh:mm:ss',
                    choose: function(date) {
                        switch (mark) {
                            // 产品模块的交付日期
                            case 1: haha.addProducts[index].endDeliveryDate = date; break;
                            case 2: haha.addProducts[index].endPayDate = date; break;
                            // 标单的起止日期
                            case 3: haha.startTime = date; break;
                            case 4: haha.endTime = date; break;
                            default:
                                layer.alert(
                                    '初始化日期控件失败, 原因: mark为[' + mark + '] , 传参错误 !',
                                    {title: '提示框', icon: 0}
                                ); break;
                        }
                    }
                })
            },
            checkName: function () {
                if (haha.name == '') {
                    haha.markNameTip(-1, null)
                }else {
                    if(haha.initName != haha.name) {
                        $.ajax({
                            url: "/bidding/" + haha.name + '/unique',
                            type: "get",
                            success: function (resp) {
                                resp.code == 200 ? haha.markNameTip(1, resp.msg) : haha.markNameTip(-1, resp.msg)
                            },
                            error: function (xhr, textStatus, errorThrown) {
                                var status = xhr.status;
                                layer.alert(
                                    '检查竞标单唯一性失败,状态码 [ ' + status + ' ] ,原因:' + xhr.responseText,
                                    {title: '提示框', icon: 0}
                                );
                            }
                        });
                    }else {
                        haha.nameTipOptions.isDuplicatName = true
                    }
                }
            },

            //mark=1 名称合法
            markNameTip: function (mark, tip) {
                haha.nameTipOptions.duplicatNameTip = tip == null ? '竞标单名称不能为空 !!' : tip
                haha.nameTipOptions.isDuplicatName = false
                if (mark == 1) {
                    haha.nameTipOptions.color = 'green'
                    haha.nameTipOptions.disabled = false
                }else {
                    haha.nameTipOptions.color = 'red'
                    haha.nameTipOptions.disabled = true
                }
            },

            /*
             * 创建标单 type=0:正常标单 1:草稿
             */
            submitBid: function (type) {
                if (haha.addProducts.length < 1) {
                    layer.alert(
                        '请添加产品 !',
                        {title: '提示框', icon: 0}
                    );
                }else {
                    if (haha.name == undefined || haha.name == '' ||
                        haha.startTime == undefined || haha.startTime == '' ||
                        haha.endTime == undefined || haha.endTime == '') {
                        layer.alert(
                            '必填数据项不能有空! 请检查!!',
                            {title: '提示框', icon: 0}
                        );
                    }else {
                        for (var i in haha.addProducts) {
                            var product = haha.addProducts[i]
                            var bidding = {}

                            bidding.originalName = haha.initName
                            bidding.name = haha.name
                            bidding.mark = haha.mark
                            bidding.recStartTime = haha.startTime
                            bidding.recEndTime = haha.endTime
                            bidding.bidDesc = haha.bidDesc
                            bidding.productId = product.productId
                            bidding.number = product.number
                            bidding.startPrice = product.maxUnitPrice
                            bidding.step = product.step
                            bidding.recEndDeliveryDate = product.endDeliveryDate
                            bidding.recEndPayDate = product.endPayDate
                            bidding.type = type

                            var sus = ''
                            for (var v in haha.addSuppliers) {
                                sus += haha.addSuppliers[v].supplierId
                                sus += '-'
                            }
                            bidding.recSuppliers = sus

                            haha.biddings.push(bidding)
                            bidding = {}
                        }

                        var isSubmit = true //能提交
                        for (var j in haha.biddings) {
                            var biddingCheck = haha.biddings[j]
                            if(biddingCheck.number < 1 || biddingCheck.startPrice < 1 || biddingCheck.step < 0 ||
                                biddingCheck.recStartTime >= biddingCheck.recEndTime
                            ) {
                                isSubmit = false
                                haha.biddings.splice(0, haha.biddings.length)
                                break;
                            }
                        }
// && !haha.nameTipOptions.disabled
                        if (isSubmit && !haha.nameTipOptions.disabled) {
                            $.ajax({
                                url: "/bidding",
                                type: "put",
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': "application/json"
                                },
                                // dataType: "json",
                                data: JSON.stringify(haha.biddings),
                                success: function (count) {
                                    if (count > 0) {
                                        layer.msg('', {icon: 1, content: '<h3>成功修改了 [1] 个竞标单</h3><h5>其中包含了 [' + count + '] 个产品</h5>'});
                                        haha.resetInfo()
                                    }else {
                                        layer.alert(
                                            '创建竞标单失败,原因: 记录数 [' + count +'] 小于1 !',
                                            {title: '提示框', icon: 0}
                                        );
                                    }
                                },
                                error: function (xhr, textStatus, errorThrown) {
                                    var status = xhr.status;
                                    layer.alert(
                                        '修改竞标单失败,状态码 [ ' + status + ' ] ,原因:' + xhr.responseText,
                                        {title: '提示框', icon: 0}
                                    );
                                }
                            });
                        }else {
                            layer.alert('',
                                {title: '提示框', icon: 0, content: '<h3>不能修改竞标单 !</h3><h5>请检查参与竞标产品的 [数量]、[起拍价]、[阶梯价] 或 竞标单的 [必填数据项] !!!</h5>'}
                            );
                        }
                    }
                }
            },

            resetInfo: function () {
                haha.name = ''
                haha.startTime = ''
                haha.endTime = ''
                haha.bidDesc = ''
                haha.nameTipOptions.isDuplicatName = true
                haha.biddings.splice(0, haha.biddings.length)

                bidding.productDatas.splice(0, bidding.productDatas.length)
                bidding.supplierDatas.splice(0, bidding.supplierDatas.length)
            },


            //必须禁掉form默认的submit
            disableFormSubmit: function () {
                return false;
            },

        },

        // vue初始化完时执行
        mounted: function () {
            var name = utils.storage.getSession('bidName')
            $.ajax({
                url: "/bidding/" + name + "/bidding",
                type: "get",
                success: function (resp) {
                    var biddings = resp.biddings
                    var biddingSuppliers = resp.biddingSuppliers

                    if (biddings.length > 0) {
                        var oneBid = biddings[0]
                        haha.initName = oneBid.name
                        haha.name = oneBid.name
                        haha.mark = oneBid.mark
                        haha.startTime = utils.dateFormat.timeStampToDate(oneBid.startTime)
                        haha.endTime = utils.dateFormat.timeStampToDate(oneBid.endTime)
                        haha.bidDesc = oneBid.bidDesc
                    }
                    for (var i in biddings) {
                        var product = {}
                        var bid = biddings[i]
                        product.productId = bid.product.productId
                        product.code = bid.product.code
                        product.name = bid.product.name
                        product.spec = bid.product.spec
                        product.number = bid.number
                        product.unit = bid.product.unit
                        product.maxUnitPrice = bid.startPrice
                        product.step = bid.step
                        product.endDeliveryDate = utils.dateFormat.timeStampToDate(bid.endDeliveryDate)
                        product.endPayDate = utils.dateFormat.timeStampToDate(bid.endPayDate)

                        bidding.productDatas.push(product)
                        product = {}
                    }

                    // 取出供应商约束列表
                    for (var j in biddingSuppliers) {
                        var su = {}
                        var bs = biddingSuppliers[j]
                        su.supplierId = bs.suid
                        su.name = bs.supplier.name
                        su.username = bs.supplier.username
                        su.companyName = bs.supplier.companyName
                        su.legal = bs.supplier.legal
                        su.companyAddress = bs.supplier.companyAddress
                        su.companyDesc = bs.supplier.companyDesc
                        bidding.supplierDatas.push(su)
                        su = {}
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    var status = xhr.status;
                    layer.alert(
                        '查询标单失败,状态码 [ ' + status + ' ] ,原因:' + xhr.responseText,
                        {title: '提示框', icon: 0}
                    );
                }
            });
        },
        watch: {},
        computed: {},
    });

</script>

</body>

</html>
