<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.meixin.bid_admin.mappers.dao.BiddingDao" >

    <resultMap id="queryBiddingListByUidMap" type="com.meixin.bid_admin.entity.Bidding">
        <id column="id" property="id" jdbcType="INTEGER" />
        <id column="name" property="name" jdbcType="INTEGER" />
        <id column="product_id" property="productId" jdbcType="INTEGER" />
        <id column="count" property="count" jdbcType="INTEGER" />
        <id column="mark" property="mark" jdbcType="INTEGER" />
        <id column="status" property="status" jdbcType="INTEGER" />
        <id column="type" property="type" jdbcType="INTEGER" />
        <id column="bid_desc" property="bidDesc" jdbcType="VARCHAR" />
        <id column="start_time" property="startTime" jdbcType="TIMESTAMP" />
        <id column="end_time" property="endTime" jdbcType="TIMESTAMP" />
        <id column="create_time" property="createTime" jdbcType="TIMESTAMP" />
        <id column="update_time" property="updateTime" jdbcType="TIMESTAMP" />

        <association property="product" javaType="com.meixin.bid_admin.entity.Product">
            <result column="product_id" property="productId" jdbcType="INTEGER" />
            <result column="p_name" property="name" jdbcType="VARCHAR" />
            <result column="spec" property="spec" jdbcType="VARCHAR" />
            <result column="unit" property="unit" jdbcType="VARCHAR" />
        </association>
    </resultMap>

    <select id="queryBiddingListByUid" parameterType="com.meixin.bid_admin.web.dto.BiddingCondition" resultMap="queryBiddingListByUidMap">
        SELECT
          B.id, B.name, B.mark, B.product_id, B.status, B.type, B.bid_desc,
          B.start_time, B.end_time, B.create_time, B.update_time, count(0) count,
          P.product_id, P.name p_name, P.spec, P.unit
        FROM bidding B
        INNER JOIN product P ON P.product_id=B.product_id
        <where>
            <if test="uid != -1">B.uid=#{uid}</if>
            <if test="name != null and name != ''"> AND B.name=#{name}</if>
            <if test="type != null"> AND B.type=${type}</if>
            <choose>
                <when test="status == 0">AND B.status=${status}</when>
                <when test="status == 1">AND B.status=${status}</when>
                <when test="status == 2">AND B.status=${status}</when>
                <when test="status == 3">AND B.status=${status}</when>
                <otherwise>AND B.status!=3</otherwise>
            </choose>
            <if test="(startDate != null and startDate != '') and (endDate != null and endDate != '')">
                AND B.create_time BETWEEN #{startDate} AND #{endDate}
            </if>
        </where>
        GROUP BY B.name
        <if test="sortName != null and sortName == 'name'">ORDER BY B.name ${sortOrder}</if>
        <if test="sortName != null and sortName == 'mark'">ORDER BY B.mark ${sortOrder}</if>
        <if test="sortName != null and sortName == 'type'">ORDER BY B.type ${sortOrder}</if>
        <if test="sortName != null and sortName == 'count'">ORDER BY count ${sortOrder}</if>
        <if test="sortName != null and sortName == 'startTime'">ORDER BY B.start_time ${sortOrder}</if>
        <if test="sortName != null and sortName == 'endTime'">ORDER BY B.end_time ${sortOrder}</if>
        <if test="sortName != null and sortName == 'createTime'">ORDER BY B.create_time ${sortOrder}</if>
        <if test="sortName != null and sortName == 'updateTime'">ORDER BY B.update_time ${sortOrder}</if>
        limit #{start}, #{size}
    </select>

    <select id="queryBiddingListTotal" parameterType="com.meixin.bid_admin.web.dto.BiddingCondition" resultType="int">
        SELECT count(DISTINCT name) FROM bidding
        <where>
            <if test="uid != -1">uid=#{uid}</if>
            <if test="name != null and name != ''"> AND name=#{name}</if>
            <if test="type != null"> AND type=${type}</if>
            <choose>
                <when test="status == 0">AND status=${status}</when>
                <when test="status == 1">AND status=${status}</when>
                <when test="status == 2">AND status=${status}</when>
                <when test="status == 3">AND status=${status}</when>
                <otherwise>AND status!=3</otherwise>
            </choose>
            <if test="(startDate != null and startDate != '') and (endDate != null and endDate != '')">
                AND create_time BETWEEN #{startDate} AND #{endDate}
            </if>
        </where>
    </select>

    <select id="queryCheckBiddingListByUid" parameterType="com.meixin.bid_admin.web.dto.BiddingCondition" resultMap="queryBiddingListByUidMap">
        SELECT
        B.id, B.name, B.mark, B.product_id, B.status, B.type, B.bid_desc,
        B.start_time, B.end_time, B.create_time, B.update_time, count(0) count,
        P.product_id, P.name p_name, P.spec, P.unit
        FROM bidding B
        INNER JOIN product P ON P.product_id=B.product_id
        <where>
            <if test="name != null and name != ''">B.name=#{name}</if>
            <if test="type != null"> AND B.type=${type}</if>
            <choose>
                <when test="status == 0">AND B.status=${status}</when>
                <when test="status == 1">AND B.status=${status}</when>
                <when test="status == 2">AND B.status=${status}</when>
                <when test="status == 3">AND B.status=${status}</when>
                <otherwise>AND B.status!=3</otherwise>
            </choose>
            <if test="(startDate != null and startDate != '') and (endDate != null and endDate != '')">
                AND B.create_time BETWEEN #{startDate} AND #{endDate}
            </if>
        </where>
        GROUP BY B.name
        <if test="sortName != null and sortName == 'name'">ORDER BY B.name ${sortOrder}</if>
        <if test="sortName != null and sortName == 'mark'">ORDER BY B.mark ${sortOrder}</if>
        <if test="sortName != null and sortName == 'type'">ORDER BY B.type ${sortOrder}</if>
        <if test="sortName != null and sortName == 'count'">ORDER BY count ${sortOrder}</if>
        <if test="sortName != null and sortName == 'startTime'">ORDER BY B.start_time ${sortOrder}</if>
        <if test="sortName != null and sortName == 'endTime'">ORDER BY B.end_time ${sortOrder}</if>
        <if test="sortName != null and sortName == 'createTime'">ORDER BY B.create_time ${sortOrder}</if>
        <if test="sortName != null and sortName == 'updateTime'">ORDER BY B.update_time ${sortOrder}</if>
        limit #{start}, #{size}
    </select>

    <select id="queryCheckBiddingListTotal" parameterType="com.meixin.bid_admin.web.dto.BiddingCondition" resultType="int">
        SELECT count(DISTINCT name) FROM bidding
        <where>
            <if test="name != null and name != ''">name=#{name}</if>
            <if test="type != null"> AND type=${type}</if>
            <choose>
                <when test="status == 0">AND status=${status}</when>
                <when test="status == 1">AND status=${status}</when>
                <when test="status == 2">AND status=${status}</when>
                <when test="status == 3">AND status=${status}</when>
                <otherwise>AND status!=3</otherwise>
            </choose>
            <if test="(startDate != null and startDate != '') and (endDate != null and endDate != '')">
                AND create_time BETWEEN #{startDate} AND #{endDate}
            </if>
        </where>
    </select>

    <delete id="deleteBiddings">
        DELETE FROM bidding
        <where>
            status=4 AND name in
            <foreach collection="names" item="name" index="index" open="(" close=")" separator=",">
                #{name}
            </foreach>
            <if test="uid != -1">AND uid=#{uid}</if>
        </where>
    </delete>

    <resultMap id="productsByNameMap" type="com.meixin.bid_admin.entity.Bidding">
        <id column="id" property="id" jdbcType="INTEGER" />
        <id column="name" property="name" jdbcType="INTEGER" />
        <id column="product_id" property="productId" jdbcType="INTEGER" />
        <id column="mark" property="mark" jdbcType="INTEGER" />
        <id column="status" property="status" jdbcType="INTEGER" />
        <id column="type" property="type" jdbcType="INTEGER" />
        <id column="bid_desc" property="bidDesc" jdbcType="VARCHAR" />
        <id column="start_price" property="startPrice" jdbcType="FLOAT" />
        <id column="step" property="step" jdbcType="FLOAT" />
        <id column="number" property="number" jdbcType="INTEGER" />
        <id column="end_delivery_date" property="endDeliveryDate" jdbcType="TIMESTAMP" />
        <id column="end_pay_date" property="endPayDate" jdbcType="TIMESTAMP" />
        <id column="start_time" property="startTime" jdbcType="TIMESTAMP" />
        <id column="end_time" property="endTime" jdbcType="TIMESTAMP" />
        <id column="create_time" property="createTime" jdbcType="TIMESTAMP" />
        <id column="update_time" property="updateTime" jdbcType="TIMESTAMP" />

        <association property="product" javaType="com.meixin.bid_admin.entity.Product">
            <result column="product_id" property="productId" jdbcType="INTEGER" />
            <result column="p_name" property="name" jdbcType="VARCHAR" />
            <result column="spec" property="spec" jdbcType="VARCHAR" />
            <result column="unit" property="unit" jdbcType="VARCHAR" />
            <result column="code" property="code" jdbcType="VARCHAR" />
            <result column="product_desc" property="productDesc" jdbcType="VARCHAR" />
        </association>
    </resultMap>

    <select id="queryProductsByBiddingName" resultMap="productsByNameMap">
        SELECT
          B.id, B.name,B.mark, B.product_id, B.status, B.type, B.bid_desc, B.start_price, B.step, B.number,
          B.end_delivery_date, B.end_pay_date,
          B.start_time, B.end_time, B.create_time, B.update_time,
          P.product_id, P.name p_name, P.spec, P.unit, P.code, P.product_desc
        FROM bidding B
        INNER JOIN product P ON P.product_id=B.product_id
        WHERE B.name=#{name}
    </select>

    <update id="releaseBiddings" parameterType="map">
        UPDATE bidding
        SET type=0, status=3
        <where>
            name in
            <foreach collection="names" item="name" index="index" open="(" close=")" separator=",">
                #{name}
            </foreach>
            <if test="uid != -1">AND uid=#{uid}</if>
        </where>
    </update>


    <select id="queryBiddingListByBidNames" parameterType="map" resultType="com.meixin.bid_admin.entity.Bidding">
        select * from bidding
        <where>
            name in
            <foreach collection="names" item="name" index="index" open="(" close=")" separator=",">
                #{name}
            </foreach>
        </where>
        GROUP BY name
    </select>

    <update id="checkokBiddings" parameterType="map">
        UPDATE bidding
        SET status=0
        <where>
            name in
            <foreach collection="names" item="name" index="index" open="(" close=")" separator=",">
                #{name}
            </foreach>
        </where>
    </update>

    <update id="saveToDraft" parameterType="map">
        UPDATE bidding
        SET type=1,status=4
        <where>
            name in
            <foreach collection="names" item="name" index="index" open="(" close=")" separator=",">
                #{name}
            </foreach>
        </where>
    </update>

</mapper>